# 開発ノート

## 概要

年賀状宛名印刷システム。CSV から PDF を生成する Docker パッケージ。

## 技術構成

- **pandoc-embedz** - Jinja2 テンプレートエンジン
- **vivliostyle** - CSS 組版エンジン
- **Klee One** - Web フォント（Google Fonts）
- **Docker** - パッケージング
- **dozo** - Docker 実行ヘルパー（オプション）

## 設計上の決定

### OFFSET オプション

プリンタの印刷位置ズレを補正するオプション。

```bash
dozo make OFFSET=-1.5mm           # 左に 1.5mm
dozo make OFFSET="-1.5mm, 0.5mm"  # 左に 1.5mm、上に 0.5mm
```

実装: `--css "data:,.card{transform:translate(X, Y)}"` で vivliostyle に渡す。

当初は margin で実装を検討したが、transform の方が X,Y 座標として直感的。

### 夫婦別姓対応

配偶者・子供の名前にスペースがあれば、最初のスペースで姓と名に分割して表示。

```
配偶者: "北条 政子" → 北条 | 政子 | 様
子供: "太一・花子" → 太一様、花子様（従来通り）
子供: "山田 太一・鈴木 花子" → 山田|太一|様、鈴木|花子|様
```

子供の区切りは「・」と「／」の両方に対応。

### ファイル命名

- `*.pdf` - 印刷用
- `*.preview.pdf` - プレビュー用（`.` 区切りでソート順を改善）

当初は `-preview.pdf` だったが、ファイル一覧で csv, pdf, preview の順になるのが不便なため変更。

### ファイルパーミッション

Docker 内で作成されるファイルが 600 になる問題があった。
`entrypoint.sh` で `umask 022` を設定して解決。

## 拡張性

### フォントの変更

現在は Google Fonts の Klee One を使用（`style.css` で `@import`）。

変更方法：
1. `make init` でローカルにファイルをコピー
2. `style.css` の `@import` URL を変更
3. `font-family` を変更

ローカルフォントを使う場合は `@font-face` で定義。
ただし Docker 内で利用するにはフォントファイルをコンテナに含める必要あり。

### 縦書き対応

現在は横書きのみ。縦書き対応には以下が必要：

1. **CSS の変更**
   - `writing-mode: vertical-rl` を設定
   - レイアウト（位置、サイズ）の全面的な見直し
   - 数字の表記（漢数字 or 縦中横）

2. **テンプレートの変更**
   - 住所の数字を漢数字に変換するフィルタ
   - 番地の区切り（1-2-3 → 一丁目二番三号）

3. **検討事項**
   - 横書き版と縦書き版を別ファイルにするか、オプションで切り替えるか
   - `style-vertical.css` のような別ファイルが現実的

### 文字数による調整

長い住所や名前への対応：
- 現在は CSS の `word-break` と `overflow-wrap` で折り返し
- フォントサイズの自動調整は未実装
- 必要なら JavaScript で文字数に応じてクラスを付与する方法

### 敬称のカスタマイズ

現在は「様」固定。変更するには：
- CSV に敬称列を追加
- テンプレート（`nenga.emz`）を修正
- 「様」「殿」「御中」「先生」など

### 年賀状以外への対応

暑中見舞い、喪中はがきなど：
- 基本的なレイアウトは同じ（はがきサイズ）
- 差出人の配置や装飾が異なる場合はスタイル追加
- 現状でもスタイルをカスタマイズすれば対応可能

### JavaScript による拡張

vivliostyle は Chromium ベースのため、HTML 内で JavaScript が動作する。

可能な用途：
- 文字数に応じたフォントサイズ自動調整
- 動的なクラス付与（長い住所、多い家族など）
- 数字の漢数字変換（縦書き対応）
- 住所の整形（番地の表記統一など）

実装方法：
1. `nenga.emz` テンプレートに `<script>` タグを追加
2. または外部 JS ファイルを作成して読み込み

注意点：
- vivliostyle のレンダリングタイミングとの兼ね合い
- 動作確認が必要（未検証）
